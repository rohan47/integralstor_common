#!/usr/bin/python
from os import listdir
import os.path,time
from integralstor_common import scheduler_utils
from integralstor_common.common import get_clamav_config_path, get_clamav_log_folder_path, get_python_scripts_path, get_clamav_quarantine_path, clamav_virus_definations_directory
from integralstor_common.command import get_command_output  

def check_dataset_scan_list(name):
  ret_val = None
  try:
    root,err = get_clamav_config_path()
    if err:
      raise Exception(err)
    with open('%s/scan_list.txt'%root,'r') as f:
      complete_file = f.read()
      list_of_datasets = complete_file.split('\n')
    if '/'+name in list_of_datasets:
      ret_val = True
    else:
      ret_val = False
  except Exception,e:
    return ret_val, 'File scan_list.txt not found: %s'%str(e)
  else:
    return ret_val, None

def change_dataset_scan_list(name, changed):
  ret_val = None
  try:
    root,err = get_clamav_config_path()
    if err:
      raise Exception(err)
    old_status,err = check_dataset_scan_list(name)
    if err:
      raise Exception(err)
    if changed and not old_status:
      with open('%s/scan_list.txt'%root,'a') as f:
        f.write('/%s\n'%name)
      ret_val = True
    elif not changed and old_status:
      with open('%s/scan_list.txt'%root,'r') as f:
        lines = f.readlines()
      with open('%s/scan_list.txt'%root,'w') as f:
        for line in lines:
          if line.strip('\n') != '/%s'%name:
            f.write(line)
      ret_val = False
  except Exception , e:
    return ret_val, 'Error changing virus scan status: %s'%str(e)
  else:
    return ret_val, None

def virus_scan_log():
  ret_val = None
  try:
    root,err = get_clamav_log_folder_path()
    if err:
      raise Exception(err)
    with open('%s/clamav.log'%root,'r') as f:
      f.seek(0)
      lines = f.read()
    av_log_list = lines.split('\n')
    av_log_list.reverse()
    ret_val = av_log_list
  except Exception,e:
    return ret_val, 'Error retriving clamav log: %s',str(e)
  else:
    return ret_val, None


def get_clamav_conf_file(service):
  ret_val = None
  try:
    if service not in ['clamd','freshclam']:
      raise Exception('Invalid clamav service')
    root,err = get_clamav_config_path()
    if err:
      raise Exception(err)
    with open('%s/config/%s.conf'%(root,service),'r') as f:
      conf = f.read()
    conf_list = conf.split('\n')
    conf_dict = dict()
    for i in conf_list:
      if i=='':
        pass
      elif i[0]=='#':
        pass
      else :
        entry = i.split(' ')
        if entry[0] not in ['VirusEvent','OnOutdatedExecute']:
          conf_dict.update({entry[0]:entry[1]})
    ret_val = conf_dict
  except Exception,e:
    return None,'Error retriving %s conf file: %s'%(service,str(e))
  else:
    return ret_val, None



def write_clamav_conf_file(conf_dict,service):
  ret_val = None
  try:
    if service not in ['clamd','freshclam']:
      raise Exception('Invalid clamav service')
    script_root,err = get_python_scripts_path()
    root,err = get_clamav_config_path()
    if err:
      raise Exception(err)
    st = None
    with open('%s/config/%s.conf'%(root,service),'w') as f:
      for key in conf_dict.iterkeys():
        f.write('%s %s\n'%(key,conf_dict[key]))
      if service == 'clamd':
        f.write('VirusEvent %s/virusevent.py "%%v"\n'%script_root)
        cmd = 'systemctl restart clamd@scan'
        status,err = get_command_output(cmd)
        if err:
          raise Exception(err)
      elif service == 'freshclam':
        f.write('OnOutdatedExecute %s/update_event.py "%%v"\n'%script_root)
        get_command_output('killall freshclam')
        cmd = 'freshclam -d'
        status,err = get_command_output(cmd)
      if err:
        raise Exception(err)
  except Exception,e:
    return None,'Error writing %s conf file: %s'%(service,str(e))
  else:
    return ret_val, None


#[u'0', u'0', u'*', u'*', u'*']
def add_clamav_cron(schedule,old_cron_id):
  ret_val = None
  try:
    root,err = get_clamav_config_path()
    if err:
      raise Exception(err)
    if old_cron_id:
      cron_remove,err = scheduler_utils.remove_cron(old_cron_id)
      if err:
        raise Exception(err)
    cmd = 'clamdscan --no-summary --quiet -m -c /etc/clamd.d/scan.conf --move /opt/integralstor/integralstor_unicell/config/clamav/quarantine/  -f  /opt/integralstor/integralstor_unicell/config/clamav/scan_list.txt '
    description = 'ClamAV Scan'
    cron_task_id, err = scheduler_utils.add_cron_task(cmd, description,schedule[0],schedule[1],schedule[2],schedule[3],schedule[4])
    if err:
      raise Exception(err)
    with open('%s/cron_id'%root,'w') as f:
      f.write(str(cron_task_id))
    ret_val = cron_task_id
  except Exception, e :
    return None, 'Error adding cron task for clamav: %s'%str(e)
  else:
    return ret_val,None

def get_clamav_cron_id():
  ret_val = None
  try:
    root,err = get_clamav_config_path()
    if err:
      raise Exception(err)
    with open('%s/cron_id'%root,'r') as f:
      cron_task_id = f.read()
    if cron_task_id == '':
      schedule = [u'0', u'0', u'*', u'*', u'*']
      status,err = add_clamav_cron(schedule,None)
      if err:
        raise Exception(err)
    else:
      ret_val = int(cron_task_id)
  except Exception,e:
    return None, 'Error retriving cron id: %s'%str(e)
  else:
    return ret_val,None

def match_date(filename):
  ret_val = None
  try:
    root,err = get_clamav_config_path()
    if err:
      raise Exception(err)
    file_stamp = time.ctime(os.path.getctime('%s/virus_definations/%s'%(root,filename)))
    file_stamp = file_stamp.split(' ')
    current_time = time.ctime()
    current_time = current_time.split(' ')
    if '' in file_stamp:
      file_stamp.remove('')
    if '' in current_time:
      current_time.remove('')
    if file_stamp[0] == current_time[0] and file_stamp[1] == current_time[1] and file_stamp[2] == current_time[2] and file_stamp[4] == current_time[4]:
      ret_val = True
    else:
      ret_val = False
  except Exception,e:
    return None,"Unable to check time stamp of the update file: %s"%str(e)
  else:
    return ret_val,None

def del_virus(virus_file):
  ret_val = None
  try:
    root,err = get_clamav_quarantine_path()
    if err:
      raise Exception(err)
    cmd = 'rm -rf %s/%s'%(root,virus_file)
    status,err = get_command_output(cmd)
    if err:
      raise Exception(err)
    ret_val = True
  except Exception,e:
    return None, 'Error deleting virus file: %s'%str(e)
  else:
    return ret_val,None

def del_all_virus():
  ret_val = None
  try:
    virus_list,err = quarantine_list()
    if err:
      raise Exception(err)
    root,err = get_clamav_quarantine_path()
    if err:
      raise Exception(err)
    if virus_list:
      for f in virus_list:
        cmd = 'rm -rf %s/%s'%(root,f)
        status,err = get_command_output(cmd)
        if err:
          raise Exception(err)
        ret_value = True
  except Exception,e:
    return None, 'Error deleting virus file: %s'%str(e)
  else:
    return ret_val,None

def quarantine_list():
  ret_val = None
  try:
    root,err = get_clamav_quarantine_path()
    if err:
      raise Exception(err)
    virus_list = listdir('%s/'%root)
    ret_val = virus_list
  except Exception,e:
    return None, 'Error retriving quarantine list: %s'%str(e)
  else:
    return ret_val,None

def virus_definations(update_file_name, save=None):
  ret_val = None
  try:
    root,err = clamav_virus_definations_directory()
    if err:
      raise Exception(err)
    if not save:
      cmd = 'rm -f %s/%s'%(root,update_file_name)
      status,err = get_command_output(cmd)
      if err:
        raise Exception(err)
      cmd = 'rm -f /var/lib/clamav/%s'%update_file_name
      status,err = get_command_output(cmd)
      if err:
        raise Exception(err)
    elif save:  
      confirm,err = match_date(update_file_name)
      if err:
        raise Exception(err)
      if not confirm:
        raise Exception('Update file is not downloaded today. Use the update file downloaded today')
      cmd = 'ln -s %s/%s  /var/lib/clamav/%s'%(root,update_file_name,update_file_name)
      status,err = get_command_output(cmd)
      if err:
        raise Exception(err)
      cmd = 'systemctl restart clamd@scan'
      status,err = get_command_output(cmd)
      if err:
        raise Exception(err)
      ret_val = True
  except Exception,e:
    return None,'Error uploading update file: %s'%str(e)
  else:
    return ret_val,None

def restore_default_clamav_conf():
  ret_val = None
  try:
    root,err = get_clamav_config_path()
    if err:
      raise Exception(err)
    with open('%s/config/clamd.conf.default'%root,'r') as f:
      lines = f.readlines()
    with open('%s/config/clamd.conf'%root,'w') as f:
      for line in lines:
        f.write(line)
    with open('%s/config/freshclam.conf.default'%root,'r') as f:
      lines = f.readlines()
    with open('%s/config/freshclam.conf'%root,'w') as f:
      for line in lines:
        f.write(line)
    ret_val = True
  except Exception,e:
    return None,'Error restoring default configuration: %s'%str(e)
  else:
    return ret_value,None


